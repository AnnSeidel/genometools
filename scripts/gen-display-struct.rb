#!/usr/bin/env ruby

def keywords(display_options)
  extra = ["alignment","polinfo","fstperquery","failed_seed","seed_in_align"]
  kws = Array.new()
  idx = 0
  display_options.each do |arg,helpline|
    incolumn = if extra.member?(arg) then "false" else "true" end
    kws.push([arg,idx,incolumn])
    idx += 1
  end
  return kws
end

def indent(longest,arg)
  return " " * (longest - arg.length + 1)
end

def format(longest,helpline)
  len = longest + 3
  out = Array.new()
  helpline.split(/\s/).each do |w|
    if len + w.length <= 58
      out.push(w)
      len += w.length
    else
      out.push("\\n\"\n" + " " * 9 + "\"" + " " * (longest+2) + w)
      len = longest + 1 + w.length
    end
  end
  return out.join(" ")
end

class String
  def dot2us
    return self.gsub(/\./,"_")
  end
  def format_enum_value
    return "Gt_" + self.dot2us.capitalize + "_display"
  end
end

# The following help line defines which keywords can be used as arguments
#  to option -outfmt. Each keyword follows a newline and ends with a :. This
#  is exploited by generating the list of possible keyword for
#  checking the -outfmt argument list generated by
#  gt_se_help2display_strings. The list of keywords must correspond
#  to the type above.

display_options = [
  ["alignment",   "display alignment (possibly followed by =<number> to " +
                  "specify width of alignment columns)"],
  ["cigar",       "show cigar string representing alignment"],
  ["polinfo",     "display polishing information for displayed alignment"],
  ["fstperquery", "output only the first found match per query"],
  ["seed",        "display the seed of the match, i.e. the length and " +
                  "the start position of the seed in both instances"],
  ["failed_seed", "display the seed of the match that was extended, " +
                  "but failed (after extension) the filter conditions"],
  ["seed_in_algn","display the seed in alignment"],
  ["seqlength",   "display length of sequences in which " +
                  "the two match-instances occur"],
  ["evalue",      "display evalue"],
  ["s.seqdesc",   "display sequence description of subject sequence"],
  ["q.seqdesc",   "display sequence description of query sequence"],
  ["bitscore",    "display bit score"]]

outfilename = "src/match/se-display.inc"
begin
  fpout = File.new(outfilename,"w")
rescue => err
  STDERR.puts "#{$0}: cannot create file #{outfilename}"
  exit 1
end

fpout.puts <<'EOF'
typedef struct
{
  const char *name;
  int rank;
  bool incolumn;
} GtSEdisplayStruct;

struct GtSeedExtendDisplayFlag
{
  unsigned int flags;
  bool a_seedpos_relative, b_seedpos_relative;
  GtUword alignmentwidth;
};

static GtSEdisplayStruct gt_display_arguments_table[] =
{
EOF

kws = keywords(display_options)

fpout.puts kws.sort {|a,b| a[0] <=> b[0]}.
         map{|s,idx,f| "  {\"#{s}\", #{idx}, #{f}}"}.join(",\n")

fpout.puts <<'EOF'
};

typedef enum
{
EOF

fpout.puts kws.map{|s,idx,f| " #{s.format_enum_value}"}.join(",\n")

fpout.puts <<EOF
} GtSeedExtendDisplay_enum;

#define GT_DISPLAY_LARGEST_FLAG #{kws.length-1}

const char *gt_querymatch_display_help(void)
{
  return "specify what information about the matches to display\\n\"
EOF

longest = 0
display_options.each do |arg,helpline|
  if longest < arg.length
    longest = arg.length
  end
end

display_options.each do |arg,helpline|
  fpout.puts " " * 9 + "\"#{arg}:#{indent(longest,arg)}" +
       "#{format(longest,helpline)}\\n\""
end

fpout.puts <<'EOF'
;
}

static unsigned int gt_display_mask(int shift)
{
  return 1U << shift;
}

static bool gt_querymatch_display_on(const GtSeedExtendDisplayFlag
                                       *display_flag,
                                     GtSeedExtendDisplay_enum display)
{
  gt_assert((int) display <= GT_DISPLAY_LARGEST_FLAG);
  return (display_flag != NULL &&
          (display_flag->flags & gt_display_mask(display))) ? true : false;
}
EOF

display_options.each do |arg,helpline|
  fpout.puts <<EOF

bool gt_querymatch_#{arg.dot2us}_display(const GtSeedExtendDisplayFlag
                                        *display_flag)
{
  return gt_querymatch_display_on(display_flag,#{arg.format_enum_value});
}
EOF
end
